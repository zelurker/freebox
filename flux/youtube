#!/usr/bin/perl

use common::sense;
use search;

# une refonte ultra simplifiée du plugin youtube :
# puisqu'on s'en sort pas avec le décodage html, on fait une approche inverse : on demande un titre, qu'on cherche sur un moteur de recherche
# si on trouve un line youtube, on le passe directement à mpv, fin de l'histoire !
# TODO: ajouter une option pour enregistrer la vidéo sur disque en option, pour l'instant il lit directrement sans garder aucune trace

my $str = shift @ARGV;
if (!$str) {
	say "Recherche";
	exit(0);
}
say STDERR "obtenu $str";
$str =~ s/^result://;
my $mech = search::search($str);
$mech->save_content("page.html");
my @yt;
foreach ($mech->links) {
	my $u = $_->url;
	if ($u =~ /youtube.com.watch/) {
		next if (!$_->text);
		next if ($_->text =~ /^www.youtube/);
		next if ($u eq $yt[$#yt]);
		push @yt, $_->text;
		push @yt, $u;
	}
}
if ($#yt == 1) { # 1 seule url
	say $yt[1];
	exit(0);
} elsif ($#yt > 1) {
	say "direct";
	for (my $n=0; $n<=$#yt; $n+=2) {
		say $yt[$n];
		say $yt[$n+1];
	}
	exit(0);
}
say "Désolé, pas trouvé de lien youtube";
exit(0);

